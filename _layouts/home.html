---
layout: default
refactor: true
---
{% include lang.html %}

{%- comment -%}
  Filter posts by active language so homepage only shows current language's posts.
  Polyglot sets site.active_lang during each language build.
{%- endcomment -%}
{%- comment -%} Debug: site.active_lang = "{{ site.active_lang }}", total posts = {{ site.posts | size }} {%- endcomment -%}
{% assign all_lang_posts = site.posts | where: 'lang', site.active_lang %}
{%- comment -%} Filter out synthetic posts for homepage listings (FR-019, FR-025) {%- endcomment -%}
{% assign localized_posts = all_lang_posts | where_exp: 'item', 'item.synthetic_translation != true' %}
{%- comment -%} Debug: localized posts for lang="{{ site.active_lang }}" = {{ localized_posts | size }}, all posts = {{ all_lang_posts | size }} {%- endcomment -%}
{% assign pinned = localized_posts | where: 'pin', 'true' | sort: 'date' | reverse %}
{% assign unpinned = localized_posts
  | where_exp: 'item', 'item.pin != true and item.hidden != true'
  | sort: 'date'
  | reverse
%}

{%- comment -%}
  Simplified per-language listing (pagination removed for now to avoid nil slots created by cross-language paginator).
  Future enhancement: implement per-language pagination by slicing the combined list.
{%- endcomment -%}
{% assign posts = pinned | concat: unpinned %}

{%- comment -%}
  Manual per-language pagination (Step C):
  We avoid the built-in paginator (which mixes languages) and instead slice the
  language-filtered posts array here. This will automatically work for both
  zh-CN and en builds because Polyglot sets site.active_lang and page.url.
  When total_pages == 1 the pagination UI is omitted.
{%- endcomment -%}
{% assign per_page = site.paginate | default: 10 %}
{% assign total_posts = posts | size %}
{% assign total_pages_float = total_posts | divided_by: per_page %}
{%- comment -%}
  Liquid integer division truncates; emulate ceil: if (total_posts % per_page) > 0 then +1
{%- endcomment -%}
{% assign remainder = total_posts | modulo: per_page %}
{% assign total_pages = total_posts | divided_by: per_page %}
{% if remainder > 0 %}{% assign total_pages = total_pages | plus: 1 %}{% endif %}

{%- comment -%} Derive current page number from URL pattern '/page/N/' {%- endcomment -%}
{% assign current_page = 1 %}
{% assign segments = page.url | split: '/' %}
{% for seg in segments %}
  {% if seg == 'page' %}
    {% assign idx = forloop.index0 | plus: 1 %}
    {% assign next_seg = segments[idx] %}
    {% if next_seg != null and next_seg != '' %}
      {% assign current_page = next_seg | plus: 0 %}
    {% endif %}
  {% endif %}
{% endfor %}

{%- comment -%}
  Slice posts for current page.
{%- endcomment -%}
{% assign offset = per_page | times: current_page | minus: per_page %}
{% assign page_posts = posts | slice: offset, per_page %}

{%- comment -%}
  Build language-aware base prefix for links.
{%- endcomment -%}
{% assign base_prefix = '' %}
{% if site.active_lang != site.default_lang %}
  {% assign base_prefix = '/' | append: site.active_lang %}
{% endif %}

{%- comment -%}
  Previous / next page paths (nil when not applicable).
{%- endcomment -%}
{% assign previous_page_path = null %}
{% if current_page > 1 %}
  {% assign prev_num = current_page | minus: 1 %}
  {% if prev_num == 1 %}
    {% assign previous_page_path = base_prefix | append: '/' %}
  {% else %}
    {% assign previous_page_path = base_prefix | append: '/page/' | append: prev_num | append: '/' %}
  {% endif %}
{% endif %}

{% assign next_page_path = null %}
{% if current_page < total_pages %}
  {% assign next_num = current_page | plus: 1 %}
  {% assign next_page_path = base_prefix | append: '/page/' | append: next_num | append: '/' %}
{% endif %}

<div id="post-list" class="flex-grow-1 px-xl-1">
  {%- comment -%} Empty state when no posts in current language (FR-019) {%- endcomment -%}
  {% if page_posts.size == 0 %}
    <div class="d-flex flex-column align-items-center justify-content-center py-5">
      <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
      <h3 class="text-muted">
        {%- if site.active_lang == 'en' -%}
          No posts yet in this language.
        {%- else -%}
          该文章尚未翻译
        {%- endif -%}
      </h3>
    </div>
  {% else %}
  {% for post in page_posts %}
    <article class="card-wrapper card">
      <a href="{{ post.url | relative_url }}" class="post-preview row g-0 flex-md-row-reverse">
        {% assign card_body_col = '12' %}

        {% if post.image %}
          {% assign src = post.image.path | default: post.image %}
          {% unless src contains '//' %}
            {% assign src = post.media_subpath | append: '/' | append: src | replace: '//', '/' %}
          {% endunless %}

          {% assign alt = post.image.alt | xml_escape | default: 'Preview Image' %}

          {% assign lqip = null %}

          {% if post.image.lqip %}
            {% capture lqip %}lqip="{{ post.image.lqip }}"{% endcapture %}
          {% endif %}

          <div class="col-md-5">
            <img src="{{ src }}" alt="{{ alt }}" {{ lqip }}>
          </div>

          {% assign card_body_col = '7' %}
        {% endif %}

        <div class="col-md-{{ card_body_col }}">
          <div class="card-body d-flex flex-column">
            <h1 class="card-title my-2 mt-md-0">{{ post.title }}</h1>

            <div class="card-text content mt-0 mb-3">
              <p>{% include post-description.html %}</p>
            </div>

            <div class="post-meta flex-grow-1 d-flex align-items-end">
              <div class="me-auto">
                <!-- posted date -->
                <i class="far fa-calendar fa-fw me-1"></i>
                {% include datetime.html date=post.date lang=lang %}

                <!-- categories -->
                {% if post.categories.size > 0 %}
                  <i class="far fa-folder-open fa-fw me-1"></i>
                  <span class="categories">
                    {% for category in post.categories %}
                      {{ category }}
                      {%- unless forloop.last -%},{%- endunless -%}
                    {% endfor %}
                  </span>
                {% endif %}
              </div>

              {% if post.pin %}
                <div class="pin ms-1">
                  <i class="fas fa-thumbtack fa-fw"></i>
                  <span>{{ site.data.locales[lang].post.pin_prompt }}</span>
                </div>
              {% endif %}
            </div>
            <!-- .post-meta -->
          </div>
          <!-- .card-body -->
        </div>
      </a>
    </article>
  {% endfor %}
  {% endif %}
</div>
<!-- #post-list -->

{%- if total_pages > 1 -%}
  <nav aria-label="Page Navigation">
    <ul class="pagination align-items-center mt-4 mb-0">
      {%- comment -%} Left arrow {%- endcomment -%}
      {% assign prev_url = previous_page_path | default: '#' %}
      <li class="page-item {% unless previous_page_path %}disabled{% endunless %}">
        <a class="page-link" href="{{ prev_url | relative_url }}" aria-label="previous-page">
          <i class="fas fa-angle-left"></i>
        </a>
      </li>

      {%- comment -%} Page number sequence with ellipsis behavior replicating original include {%- endcomment -%}
      {% assign left_ellipsis = false %}
      {% assign right_ellipsis = false %}
      {% assign page_minus_1 = current_page | minus: 1 %}
      {% assign page_plus_1 = current_page | plus: 1 %}
      {% assign page_minus_2 = page_minus_1 | minus: 1 %}
      {% assign page_plus_2 = page_plus_1 | plus: 1 %}
      {% for i in (1..total_pages) %}
        {% assign show = false %}
        {% if current_page == 1 %}
          {% if i <= 3 or i == total_pages %}{% assign show = true %}{% endif %}
        {% elsif current_page == total_pages %}
          {% if i == 1 or i >= page_minus_2 %}{% assign show = true %}{% endif %}
        {% else %}
          {% if i == 1 or i == total_pages -%}
            {%- assign show = true %}
          {% elsif i >= page_minus_1 and i <= page_plus_1 -%}
            {%- assign show = true -%}
          {%- endif %}
        {% endif %}

        {% if show %}
          <li class="page-item {% if i == current_page %} active{% endif %}">
            <a
              class="page-link"
              href="{% if i > 1 %}{{ base_prefix | append: '/page/' | append: i | append: '/' | relative_url }}{% else %}{{ base_prefix | append: '/' | relative_url }}{% endif %}"
            >
              {{- i -}}
            </a>
          </li>
        {% else %}
          {% if i < page_minus_1 and left_ellipsis == false %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
            {% assign left_ellipsis = true %}
          {% elsif i > page_plus_1 and right_ellipsis == false %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
            {% assign right_ellipsis = true %}
          {% endif %}
        {% endif %}
      {% endfor %}

      <li class="page-index align-middle">
        <span>{{ current_page }}</span>
        <span class="text-muted">/ {{ total_pages }}</span>
      </li>

      {%- comment -%} Right arrow {%- endcomment -%}
      {% assign next_url = next_page_path | default: '#' %}
      <li class="page-item {% unless next_page_path %}disabled{% endunless %}">
        <a class="page-link" href="{{ next_url | relative_url }}" aria-label="next-page">
          <i class="fas fa-angle-right"></i>
        </a>
      </li>
    </ul>
  </nav>
{%- endif -%}

{%- comment -%} End manual per-language pagination. {%- endcomment -%}
