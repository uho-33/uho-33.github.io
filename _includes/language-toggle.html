{%- comment -%}
  Minimal language toggle include. Actual behavior handled by assets/js/language-toggle.js.
  Inputs:
    - context: 'sidebar', 'topbar', or default => sets modifier class
    - translation_map: optional hash of lang => url overrides (falls back to page.permalink_lang)
    - original_slug: optional override (defaults to page.original_slug)
{%- endcomment -%}

{%- assign toggle_context = include.context | default: 'default' -%}
{%- assign default_lang = site.default_lang | default: 'zh-CN' -%}
{%- assign active_lang = page.lang | default: site.active_lang | default: default_lang -%}
{%- assign original_slug = include.original_slug
  | default: page.original_slug
  | default: page.page_id
  | default: page.url
-%}

{%- assign base_map = include.translation_map | default: page.translation_permalink_map -%}
{%- assign permalink_map_json = null -%}

{%- assign synthetic_map = false -%}
{%- if base_map and base_map != empty -%}
  {%- comment -%}
    Normalize URLs from pre-Polyglot stage:
    - Ensure non-default languages have leading '/<lang>/'
    - Ensure default language is NOT prefixed with '/<default>/'
  {%- endcomment -%}
  {%- assign pairs = base_map | sort -%}
  {%- capture _fixed -%}{
    {%- for pair in pairs -%}
      {%- assign lang_code = pair[0] -%}
      {%- assign url_val  = pair[1] -%}
      {%- if forloop.first == false -%}, {%- endif -%}
      {%- if lang_code == default_lang -%}
        {%- assign def_prefix = '/' | append: default_lang | append: '/' -%}
        {%- if url_val and url_val != '' and url_val contains def_prefix -%}
          {%- assign normalized = url_val | remove_first: def_prefix -%}
        {%- else -%}
          {%- assign normalized = url_val -%}
        {%- endif -%}
      {%- else -%}
        {%- assign has_prefix = '/' | append: lang_code | append: '/' -%}
        {%- assign hp_len = has_prefix | size -%}
        {%- assign head = url_val | slice: 0, hp_len -%}
        {%- if url_val and url_val != '' and head == has_prefix -%}
          {%- assign normalized = url_val -%}
        {%- else -%}
          {%- assign without_leading = url_val | remove_first: '/' -%}
          {%- assign normalized = '/' | append: lang_code | append: '/' | append: without_leading -%}
        {%- endif -%}
      {%- endif -%}
      "{{ lang_code }}": "{{ normalized | replace: '//' , '/' }}"
    {%- endfor -%}
  }{%- endcapture -%}
  {%- assign permalink_map_json = _fixed | strip -%}
{%- else -%}
  {%- assign synthetic_map = true -%}
  {%- assign page_url = page.url | default: '/' -%}
  {%- assign base_path = page_url -%}
  {%- if active_lang != default_lang -%}
    {%- assign lang_prefix = '/' | append: active_lang -%}
    {%- if base_path == lang_prefix -%}
      {%- assign base_path = '/' -%}
    {%- elsif base_path != '/' and base_path != '' and base_path contains lang_prefix | append: '/' -%}
      {%- assign base_path = base_path | remove_first: lang_prefix -%}
    {%- endif -%}
  {%- endif -%}

  {%- assign languages = site.languages -%}
  {%- if languages == null or languages == empty -%}
    {%- assign languages = site.config.languages -%}
  {%- endif -%}
  {%- if languages == null or languages == empty -%}
    {%- assign languages = default_lang | split: ',' -%}
  {%- endif -%}

  {%- capture generated_map -%}{
      {%- for lang_code in languages -%}
        {%- if forloop.first == false -%}, {% endif -%}
        {%- assign normalized = base_path -%}
        {%- if normalized == '/' -%}
          {%- assign normalized = '' -%}
        {%- endif -%}
        "{{ lang_code }}": "{%- if lang_code == default_lang -%}{{ base_path | default: '/' }}{%- else -%}/{{ lang_code }}{%- if normalized == '' -%}/{%- else -%}{{ normalized }}{%- endif -%}{%- endif -%}"
      {%- endfor -%}
    }{%- endcapture -%}
  {%- assign permalink_map_json = generated_map | strip -%}
{%- endif -%}

{%- if permalink_map_json == null or permalink_map_json == '' -%}
  {%- assign permalink_map_json = '{}' -%}
{%- endif -%}

<button
  type="button"
  class="language-toggle language-toggle--{{ toggle_context }}{% if toggle_context == 'sidebar' %} btn btn-link nav-link{% endif %}"
  data-component="language-toggle"
  data-default-lang="{{ default_lang }}"
  data-active-lang="{{ active_lang }}"
  data-original-slug="{{ original_slug | escape }}"
  {%- comment -%} Provide JSON with HTML-escaped quotes for safe attribute embedding {%- endcomment -%}
  data-permalink-map="{{ permalink_map_json | replace: '"', '&quot;' | replace: "'", "&#39;" }}"
  data-map-synthetic="{{ synthetic_map }}"
  aria-label="{{ 'toggle.switch_language' | t: default: 'Switch language' }}"
>
  <span class="language-toggle-icon" aria-hidden="true"></span>
  <span class="language-toggle-text sr-only">{{ 'toggle.switch' | t: default: 'Change language' }}</span>
</button>
