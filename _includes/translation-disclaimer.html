{%- comment -%}
  Translation disclaimer include.
  Usage:
    {% include translation-disclaimer.html info=disclaimer_hash %}
  Expected keys: should_render (bool), reason, source_lang, target_lang, provider, translated_at, origin_url.
{%- endcomment -%}

{%- assign disclaimer = include.info | default: page.translation_disclaimer -%}

{%- if disclaimer and disclaimer.should_render -%}
  {%- assign lang = page.lang | default: site.active_lang | default: site.default_lang -%}
  {%- assign source_lang_name = site.data.locales[lang].languages[disclaimer.source_lang] | default: disclaimer.source_lang -%}
  
  <div class="translation-disclaimer-callout">
    <div class="translation-disclaimer-callout__icon">
      <i class="fas fa-language"></i>
    </div>
    <div class="translation-disclaimer-callout__content">
      <p class="translation-disclaimer-callout__text">
        {%- if lang == 'en' -%}
          This article is a translation from <strong>{{ source_lang_name }}</strong>. Some nuances may be lost in translation.
        {%- else -%}
          本文译自<strong>{{ source_lang_name }}</strong>，翻译过程中可能存在细微差异。
        {%- endif -%}
      </p>
      {%- if disclaimer.origin_url -%}
        {%- assign default_lang = site.default_lang | default: 'zh-CN' -%}
        {%- assign target_lang = disclaimer.source_lang -%}
        {%- assign base_map = page.translation_permalink_map -%}
        {%- assign permalink_map_json = null -%}
        {%- if base_map and base_map != empty -%}
          {%- comment -%}
            Normalize URLs from pre-Polyglot stage:
            - Ensure non-default languages have leading '/<lang>/'
            - Ensure default language is NOT prefixed with '/<default>/'
          {%- endcomment -%}
          {%- assign pairs = base_map | sort -%}
          {%- capture _fixed -%}{
            {%- for pair in pairs -%}
              {%- assign lang_code = pair[0] -%}
              {%- assign url_val  = pair[1] -%}
              {%- if forloop.first == false -%}, {%- endif -%}
              {%- if lang_code == default_lang -%}
                {%- assign def_prefix = '/' | append: default_lang | append: '/' -%}
                {%- if url_val and url_val != '' and url_val contains def_prefix -%}
                  {%- assign normalized = url_val | remove_first: def_prefix -%}
                {%- else -%}
                  {%- assign normalized = url_val -%}
                {%- endif -%}
              {%- else -%}
                {%- assign has_prefix = '/' | append: lang_code | append: '/' -%}
                {%- assign hp_len = has_prefix | size -%}
                {%- assign head = url_val | slice: 0, hp_len -%}
                {%- if url_val and url_val != '' and head == has_prefix -%}
                  {%- assign normalized = url_val -%}
                {%- else -%}
                  {%- assign without_leading = url_val | remove_first: '/' -%}
                  {%- assign normalized = '/' | append: lang_code | append: '/' | append: without_leading -%}
                {%- endif -%}
              {%- endif -%}
              "{{ lang_code }}": "{{ normalized | replace: '//' , '/' }}"
            {%- endfor -%}
          }{%- endcapture -%}
          {%- assign permalink_map_json = _fixed | strip -%}
        {%- else -%}
          {%- capture permalink_map_json -%}{ "{{ default_lang }}": "{{ disclaimer.origin_url }}" }{%- endcapture -%}
        {%- endif -%}
        <a
          class="translation-disclaimer-callout__link"
          href="{{ disclaimer.origin_url }}"
          data-component="language-toggle"
          data-active-lang="{{ lang }}"
          data-default-lang="{{ default_lang }}"
          data-permalink-map="{{ permalink_map_json | replace: '"', '&quot;' }}"
        >
          {%- if lang == 'en' -%}View original{%- else -%}查看原文{%- endif -%}
        </a>
      {%- endif -%}
    </div>
  </div>
{%- endif -%}
